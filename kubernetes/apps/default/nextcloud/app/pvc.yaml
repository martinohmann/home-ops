---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nextcloud-data
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Mi  # Size does not matter
  storageClassName: nfs-csi
---
# yaml-language-server: $schema=https://kubernetes-schemas.18b.haus/volsync.backube/replicationsource_v1alpha1.json
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: nextcloud-data
spec:
  sourcePVC: nextcloud-data
  trigger:
    schedule: "0 2 * * *"
  restic:
    copyMethod: Snapshot
    pruneIntervalDays: 7
    repository: nextcloud-data-volsync
    volumeSnapshotClassName: nfs-ci
    cacheCapacity: 1Gi
    cacheStorageClassName: local-path
    cacheAccessModes: ["ReadWriteOnce"]
    storageClassName: nfs-csi
    accessModes: ["ReadWriteMany"]
    retain:
      daily: 7
      weekly: 4
      monthly: 6
    moverSecurityContext:
      fsGroup: 82
      runAsGroup: 82
      runAsUser: 82
---
apiVersion: v1
kind: Secret
metadata:
  name: nextcloud-data-volsync
stringData:
  RESTIC_REPOSITORY: "s3:http://minio.default.svc.cluster.local:9000/volsync/nextcloud-data"
  RESTIC_PASSWORD: "${SECRET_RESTIC_PASSWORD}"
  AWS_ACCESS_KEY_ID: "${SECRET_VOLSYNC_MINIO_ACCESS_KEY_ID}"
  AWS_SECRET_ACCESS_KEY: "${SECRET_VOLSYNC_MINIO_SECRET_ACCESS_KEY}"
